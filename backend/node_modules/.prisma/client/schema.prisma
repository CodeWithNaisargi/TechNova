generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  INSTRUCTOR
  STUDENT
}

enum Theme {
  LIGHT
  DARK
  SYSTEM
}

enum EducationLevel {
  SECONDARY // 10th
  HIGHER_SECONDARY // 12th
  DIPLOMA
  UNDERGRADUATE
  POSTGRADUATE
}

model User {
  id                           String    @id @default(uuid())
  email                        String    @unique
  password                     String
  name                         String
  phone                        String?
  role                         Role      @default(STUDENT)
  bio                          String?
  avatar                       String?
  isBlocked                    Boolean   @default(false)
  isEmailVerified              Boolean   @default(false)
  emailVerificationToken       String?
  emailVerificationTokenExpiry DateTime?
  createdAt                    DateTime  @default(now())
  updatedAt                    DateTime  @updatedAt

  courses            Course[]             @relation("InstructorCourses")
  enrollments        Enrollment[]
  reviews            Review[]
  progress           Progress[]
  adminLogs          AdminLog[]
  submissions        Submission[]         @relation("StudentSubmissions")
  assignmentProgress AssignmentProgress[]
  certificates       Certificate[]
  settings           UserSettings?
  notifications      Notification[]

  // Career Interest
  interestedCareerPathId String?
  interestedCareerPath   CareerPath? @relation(fields: [interestedCareerPathId], references: [id])
  careerFocusId          String? // Education-specific career focus (from config)
  onboardingCompleted    Boolean     @default(false) // Locks onboarding after completion

  // Education & Skills (ML features)
  educationLevel EducationLevel?
  userSkills     UserSkill[]
  userProjects   UserProject[]
}

model Course {
  id               String   @id @default(uuid())
  title            String
  description      String
  thumbnail        String?
  price            Float    @default(0)
  isPublished      Boolean  @default(false)
  category         String
  tags             String[]
  difficulty       String   @default("BEGINNER") // BEGINNER | INTERMEDIATE | ADVANCED
  duration         String? // e.g., "8 weeks", "40 hours"
  prerequisites    String[] @default([])
  learningOutcomes String[] @default([])
  instructorId     String
  instructor       User     @relation("InstructorCourses", fields: [instructorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sections    Section[]
  enrollments Enrollment[]
  reviews     Review[]
  assignments Assignment[]

  // ML-ready fields
  domain               String? // TECH, AGRICULTURE, HEALTHCARE, URBAN
  targetEducationLevel EducationLevel?
  hasProject           Boolean         @default(false)
  courseSkills         CourseSkill[]
  projects             Project[]
}

model Section {
  id          String  @id @default(uuid())
  title       String
  description String?
  order       Int
  courseId    String
  course      Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  lessons Lesson[]
}

model Lesson {
  id          String  @id @default(uuid())
  title       String
  description String?
  videoUrl    String
  duration    Float?
  isFree      Boolean @default(false)
  order       Int
  sectionId   String
  section     Section @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  progress    Progress[]
  attachments Attachment[]
}

model Enrollment {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId   String
  course     Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  enrolledAt DateTime @default(now())

  @@unique([userId, courseId])
}

model Progress {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  lessonId    String
  lesson      Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  isCompleted Boolean  @default(false)
  completedAt DateTime @default(now())

  @@unique([userId, lessonId])
}

model Review {
  id        String   @id @default(uuid())
  rating    Int
  comment   String
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

model AdminLog {
  id        String   @id @default(uuid())
  action    String
  details   String?
  adminId   String
  admin     User     @relation(fields: [adminId], references: [id])
  createdAt DateTime @default(now())
}

model Attachment {
  id        String   @id @default(uuid())
  name      String
  url       String
  type      String
  size      Int?
  lessonId  String
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

// ASSIGNMENT AND SUBMISSION MODELS
model Assignment {
  id            String    @id @default(uuid())
  courseId      String
  course        Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  title         String
  description   String?
  order         Int       @default(0)
  content       String?
  attachmentUrl String?
  videoUrl      String?
  dueDate       DateTime?
  maxScore      Int       @default(100)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  submissions Submission[]
  progress    AssignmentProgress[]
}

model Submission {
  id           String     @id @default(uuid())
  assignmentId String
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  studentId    String
  student      User       @relation("StudentSubmissions", fields: [studentId], references: [id], onDelete: Cascade)
  fileUrl      String
  status       String     @default("PENDING") // PENDING | APPROVED | REJECTED
  feedback     String?
  grade        Int?
  submittedAt  DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([assignmentId, studentId])
}

// ASSIGNMENT PROGRESS TRACKING
model AssignmentProgress {
  id           String     @id @default(uuid())
  userId       String
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignmentId String
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  status       String     @default("NOT_STARTED") // NOT_STARTED | IN_PROGRESS | COMPLETED | SUBMITTED
  startedAt    DateTime?
  completedAt  DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([userId, assignmentId])
}

// CERTIFICATE MODEL
model Certificate {
  id                   String   @id @default(uuid())
  userId               String
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId             String
  courseName           String
  studentName          String
  issueDate            DateTime @default(now())
  certificateId        String   @unique // e.g., "CERT-2024-REACT-001"
  completionPercentage Int      @default(100)
  pdfUrl               String? // URL to generated PDF certificate

  createdAt DateTime @default(now())

  @@unique([userId, courseId])
}

// USER SETTINGS MODEL
model UserSettings {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Notification preferences
  emailNotifications        Boolean @default(true)
  assignmentNotifications   Boolean @default(true)
  courseUpdateNotifications Boolean @default(true)

  // Privacy preferences
  profileVisibility Boolean @default(true)
  dataSharing       Boolean @default(false)

  // Theme preference
  theme Theme @default(SYSTEM)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum NotificationType {
  ENROLLMENT
  PATH
  COMPLETION
  CERTIFICATE
  SYSTEM
  ASSIGNMENT
}

// NOTIFICATION MODEL
model Notification {
  id        String           @id @default(uuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      NotificationType
  title     String
  message   String
  link      String?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
}

// CAREER PATH MODELS
model CareerPath {
  id          String        @id @default(uuid())
  title       String
  description String?
  domain      String // TECH, HEALTHCARE, AGRICULTURE, URBAN
  skills      CareerSkill[]
  users       User[]
  createdAt   DateTime      @default(now())
}

model Skill {
  id           String        @id @default(uuid())
  name         String        @unique
  description  String?
  careers      CareerSkill[]
  userSkills   UserSkill[]
  courseSkills CourseSkill[]
}

model CareerSkill {
  careerId String
  skillId  String
  career   CareerPath @relation(fields: [careerId], references: [id])
  skill    Skill      @relation(fields: [skillId], references: [id])

  @@id([careerId, skillId])
}

// ML-READY MODELS
model UserSkill {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  skillId   String
  skill     Skill    @relation(fields: [skillId], references: [id])
  level     Int      @default(0) // 0-100 proficiency
  source    String   @default("COURSE_COMPLETION") // COURSE_COMPLETION | PROJECT | MANUAL
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, skillId])
}

model CourseSkill {
  courseId String
  skillId  String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  skill    Skill  @relation(fields: [skillId], references: [id])

  @@id([courseId, skillId])
}

model Project {
  id           String        @id @default(uuid())
  courseId     String
  course       Course        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  title        String
  description  String?
  skillIds     String[] // Skills this project develops
  createdAt    DateTime      @default(now())
  userProjects UserProject[]
}

model UserProject {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  completedAt DateTime @default(now())

  @@unique([userId, projectId])
}
